var config,messaging="",firebaseInitStatus=!1;function registerServiceWorker(){navigator.serviceWorker.register(WAP_KASKUS_URL+"/firebase-messaging-sw.js").then(function(e){messaging.useServiceWorker(e),"granted"==Notification.permission&&getRegistrationToken()}).catch(function(e){console.error("Service Worker registration error : ",e)})}function getRegistrationToken(){messaging.getToken().then(function(e){e?(sendTokenToServer(e),e!=getCookie("fcm_token")&&subscribeTopic(e)):setTokenSentToServer(!1)}).catch(function(e){console.log("An error occurred while retrieving token. ",e)})}function subscribeTopic(e){$.ajax({url:WAP_KASKUS_URL+"/misc/generateSecurityToken",type:"GET",xhrFields:{withCredentials:!0},success:function(n){return"object"!=typeof n&&(n=$.parseJSON(n)),$.ajax({url:WAP_KASKUS_URL+"/user/subscribeDefaultTopic",type:"POST",data:{fcm_token:e,securitytoken:n.securitytoken},xhrFields:{withCredentials:!0},success:function(e){return"object"!=typeof e&&(e=$.parseJSON(e)),e},error:function(e){}}),n},error:function(e){}})}function requestPerm(){Notification.requestPermission().then(function(e){$(".request_fcm_section").addClass("D(n)")}).catch(function(e){console.log("Unable to get permission to notify.",e)})}function sendTokenToServer(e){isTokenSentToServer()||setTokenSentToServer(!0)}function isTokenSentToServer(){return"1"===window.localStorage.getItem("sentToServer")}function setTokenSentToServer(e){window.localStorage.setItem("sentToServer",e?"1":"0")}function show_request_fcm_popup(){"Notification"in window&&"default"===Notification.permission&&1==firebaseInitStatus&&$(".request_fcm_section").removeClass("D(n)")}function bindRequestFcm(){$(".request_fcm").unbind("click").click(function(){requestPerm()})}$(document).ready(function(){config={apiKey:WEB_PUSH_API_KEY,authDomain:WEB_PUSH_AUTH_DOMAIN,databaseURL:WEB_PUSH_DATABASE_URL,projectId:WEB_PUSH_PROJECT_ID,storageBucket:WEB_PUSH_STORAGE_BUCKET,messagingSenderId:WEB_PUSH_MESSAGING_SENDER_ID,appId:WEB_PUSH_APP_ID};try{firebase.initializeApp(config),(messaging=firebase.messaging()).usePublicVapidKey(WEB_PUSH_CERTIFICATE),messaging.onMessage(function(e){let n=e.data.title,t={body:e.data.body,icon:e.data.icon,image:e.data.image,badge:PUSH_NOTIFICATION_BADGE,tag:e.data.tag,renotify:!0,data:{click_action:e.data.url}};navigator.serviceWorker.ready.then(function(e){return e.showNotification(n,t)})}),messaging.onTokenRefresh(function(){messaging.getToken().then(e=>{setTokenSentToServer(!1),sendTokenToServer(e),getRegistrationToken()}).catch(e=>{console.log("Unable to retrieve refreshed token ",e)})}),show_request_fcm_popup(),bindRequestFcm(),registerServiceWorker(),firebaseInitStatus=!0}catch(e){}}),"permissions"in navigator&&navigator.permissions.query({name:"notifications"}).then(function(e){e.addEventListener("change",function(){"granted"==e.state&&getRegistrationToken()})});